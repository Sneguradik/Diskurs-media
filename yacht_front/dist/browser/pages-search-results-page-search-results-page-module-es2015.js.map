{"version":3,"sources":["./src/app/modules/search/pages/search-results-page/search-results-page.module.ts","./src/app/modules/search/pages/search-results-page/search-results-page-routing.module.ts","./src/app/modules/search/pages/search-results-page/search-results-page.component.ts","./src/app/modules/search/pages/search-results-page/search-results-page.component.html","./src/app/shared/functions/fetch-articles-with-topics.function.ts","./src/app/shared/classes/pageable-conetnt.class.ts"],"names":[],"mappings":"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","file":"pages-search-results-page-search-results-page-module-es2015.js","sourcesContent":["import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\n\nimport { SearchResultsPageRoutingModule } from './search-results-page-routing.module';\nimport { SearchResultsPageComponent } from './search-results-page.component';\nimport { SharedComponentsModule } from '@shared/components/shared-components.module';\nimport { FeedModule } from '@shared/modules/feed/feed.module';\nimport { SharedUiModule } from '@shared/ui/shared-ui.module';\nimport { TranslateModule } from '@ngx-translate/core';\n\n\n@NgModule({\n  declarations: [SearchResultsPageComponent],\n  imports: [\n    CommonModule,\n    SearchResultsPageRoutingModule,\n    SharedComponentsModule,\n    FeedModule,\n    SharedUiModule,\n    TranslateModule.forChild()\n  ]\n})\nexport class SearchResultsPageModule { }\n","import { NgModule } from '@angular/core';\nimport { Routes, RouterModule } from '@angular/router';\nimport { SearchResultsPageComponent } from './search-results-page.component';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: SearchResultsPageComponent\n  }\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule]\n})\nexport class SearchResultsPageRoutingModule { }\n","import { Component, OnDestroy, OnInit } from '@angular/core';\nimport { FormControl } from '@angular/forms';\nimport { ActivatedRoute, Params } from '@angular/router';\nimport { FeedService } from '@api/routes/feed.service';\nimport { TopicsService } from '@api/routes/topics.service';\nimport { IArticleView } from '@api/schemas/article/article-view.interface';\nimport { IPageResponse } from '@api/schemas/page/page-response.interface';\nimport { ITopicView } from '@api/schemas/topic/topic-view.interface';\nimport { SidebarWrapperService } from '@layout/sidebar-wrapper/sidebar-wrapper.service';\nimport { AbstractComponent } from '@shared/classes/abstract-component.class';\nimport { PageableContent } from '@shared/classes/pageable-conetnt.class';\nimport { fetchArticlesWithTopics$ } from '@shared/functions/fetch-articles-with-topics.function';\nimport { merge, Observable } from 'rxjs';\nimport { debounceTime, distinctUntilChanged, filter, map, switchMap, takeUntil } from 'rxjs/operators';\n\n@Component({\n  selector: 'app-search-results-page',\n  templateUrl: './search-results-page.component.html',\n  styleUrls: ['./search-results-page.component.scss']\n})\nexport class SearchResultsPageComponent extends AbstractComponent implements OnInit, OnDestroy {\n  public readonly query: FormControl = new FormControl();\n  public readonly pageable: PageableContent<[IArticleView, ITopicView], string> =\n    new PageableContent<[IArticleView, ITopicView], string>(this.fetch$.bind(this));\n\n  constructor(\n    private readonly activatedRoute: ActivatedRoute,\n    private readonly feedService: FeedService,\n    private readonly topicsService: TopicsService,\n    private readonly sidebarWrapperService: SidebarWrapperService\n  ) {\n    super();\n  }\n\n  ngOnInit(): void {\n    setTimeout(() => {\n      this.sidebarWrapperService.params$.next({ article: false, trending: true, navigation: true, live: false, showSidebar: true });\n    });\n\n    const urlQuery$: Observable<any> = this.activatedRoute.queryParams.pipe(map((p: Params) => p['q'] || ''));\n    urlQuery$.pipe(takeUntil(this.ngOnDestroy$)).subscribe((q: any) => this.query.setValue(q));\n    const inputQuery$: Observable<any> = this.query.valueChanges;\n    const query$ = merge(urlQuery$, inputQuery$);\n    query$.pipe(\n      filter((_: any) => !!_),\n      distinctUntilChanged(),\n      debounceTime(750),\n      switchMap((q: any) => this.pageable.setOptionsWithReset$(q)),\n      takeUntil(this.ngOnDestroy$),\n    ).subscribe();\n  }\n\n  private fetch$(page: number, query: string): Observable<IPageResponse<[IArticleView, ITopicView]>> {\n    return this.feedService.feedRequest$({\n      page,\n      query,\n    }).pipe(switchMap((_: IPageResponse<IArticleView>) => fetchArticlesWithTopics$(_, this.topicsService)));\n  }\n}\n","<section class=\"block-card margin-bottom-30\">\n    <h2 class=\"fade-1 margin-bottom-20\">{{ 'COMMON.SEARCH_PUBLICATIONS' | translate }}<a [routerLink]=\"['/tags']\">{{ 'COMMON.SEARCH_BY_TAGS' | translate }}</a></h2>\n    <app-ui-search [control]=\"query\"></app-ui-search>\n</section>\n\n<ng-container *ngIf=\"query.value\">\n    <h3 *ngIf=\"pageable.totalPages === 0\" class=\"text-center fade-1\">Ничего не найдено!</h3>\n    <h3 *ngIf=\"pageable.page === -1\" class=\"text-center fade-2\">Загрузка...</h3>\n</ng-container>\n\n<ul class=\"block-card item-space-20 no-empty\">\n    <li *ngFor=\"let a of pageable.content\">\n        <app-feed-article-view [data]=\"a[0]\" [topic]=\"a[1]\" [options]=\"{ pictureOn: true, menuOn: true }\"></app-feed-article-view>\n    </li>\n</ul>\n\n<app-pagination [pageable]=\"pageable\" [fireFirstPage]=\"false\"></app-pagination>\n","import { Observable, of } from 'rxjs';\nimport { IArticleView } from '@api/schemas/article/article-view.interface';\nimport { IPageResponse } from '@api/schemas/page/page-response.interface';\nimport { ITopicView } from '@api/schemas/topic/topic-view.interface';\nimport { ITopicViewFull } from '@api/schemas/topic/topic-view-full.interface';\nimport { map, defaultIfEmpty } from 'rxjs/operators';\nimport { TopicsService } from '@api/routes/topics.service';\n\nexport function fetchArticlesWithTopics$(\n  page: IPageResponse<IArticleView>,\n  topicsService: TopicsService\n): Observable<IPageResponse<[IArticleView, ITopicView]>> {\n    const topics: number[] = [];\n    page.content.forEach((article: IArticleView) => {\n        if (article.topics.length > 0) {\n            topics.push(article.topics[0]);\n        }\n    });\n    return page.content.length > 0 ? topicsService.getMultiple$(topics).pipe(defaultIfEmpty([]), map((topicsRet: ITopicViewFull[]) => {\n        const content: [IArticleView, ITopicView][] = [];\n        page.content.forEach((article: IArticleView) => {\n            if (article.topics.length > 0) {\n                content.push([article, topicsRet.find((x: ITopicViewFull) => x.meta.id === article.topics[0]) as ITopicView]);\n            } else {\n                content.push([article, null]);\n            }\n        });\n        return { ...page, content };\n    })) : of({ ...page, content: [] });\n}\n","import { BehaviorSubject, Subject, Observable } from 'rxjs';\nimport { IPageResponse } from '@api/schemas/page/page-response.interface';\nimport { debounce, filter, first, tap, mapTo } from 'rxjs/operators';\n\nexport const NO_CONTENT = Symbol('NO_CONTENT');\n\nexport class PageableContent<T, O = any> {\n  public readonly isFetching$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\n  public readonly content$: Subject<T[]> = new Subject<T[]>();\n  public readonly options$: BehaviorSubject<O>;\n  public readonly end$ = new Subject();\n\n  public content: T[] = [];\n  public page = -1;\n  public totalPages = 1;\n\n  private readonly fetchCommand$: Subject<never> = new Subject<never>();\n\n  constructor(\n    private readonly fetchNextFn$: (page: number, options: O) => Observable<IPageResponse<T>>,\n    options: O = null\n  ) {\n    this.options$ = new BehaviorSubject<O>(options);\n    this.fetchCommand$.pipe(debounce(() => this.isFetching$.pipe(filter((_: boolean) => !_)))).subscribe(() => this.fetchNextPage());\n  }\n\n  public fetch(): void {\n    if (this.page < this.totalPages - 1) {\n      this.fetchCommand$.next();\n    }\n  }\n\n  public reset$(hard: boolean = true): Observable<any> {\n    return this.isFetching$.pipe(\n      filter((it: boolean) => !it),\n      first(),\n      tap(() => {\n        if (hard) {\n          this.content.splice(0, this.content.length);\n        }\n        this.page = -1;\n        this.totalPages = 1;\n      }),\n    );\n  }\n\n  public setOptionsWithReset$(options: O, hard: boolean = true): Observable<O> {\n    return this.reset$(hard).pipe(\n      tap(() => {\n        this.options$.next(options);\n        this.fetch();\n      }),\n      mapTo(options),\n    );\n  }\n\n  private fetchNextPage(): void {\n    this.isFetching$.next(true);\n    this.fetchNextFn$(this.page + 1, this.options$.value).subscribe(\n      (response: IPageResponse<T>) => {\n        this.page = response.page;\n        this.totalPages = response.totalPages;\n        this.content$.next(response.content);\n        if (this.page >= this.totalPages - 1) {\n          this.end$.next();\n        }\n        this.content.push(...response.content);\n        this.isFetching$.next(false);\n      },\n      (error: any) => {\n        this.isFetching$.next(false);\n        if (error !== Symbol('NO_CONTENT')) {\n          throw error;\n        }\n      },\n    );\n  }\n}\n"],"sourceRoot":"webpack:///"}